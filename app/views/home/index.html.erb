<%= render "/common/top_bar" %>

<script type="text/javascript">
ShopifyApp.Bar.loadingOn();
   window.mainPageTitle = 'Index';

  ShopifyApp.ready(function(){
    ShopifyApp.Bar.initialize({
      title: window.mainPageTitle,
      /*icon: 'https://embedded-app-example.herokuapp.com/icon.png',*/
      buttons: {
        primary: {
          label: "Save Tabs",
          message: 'save-tabs-form-message',
		  loading:true
        },
        secondary: {
          label: "Cancel and Close",
		  <% if defined? @product %>
		callback: function(){
			ShopifyApp.redirect("/products/<%= @product.id.to_s%>");
		}
		<%else %>
		callback: function(){
			ShopifyApp.redirect("/products");
		}
		<%end %>
		 
        }
      }
    });

  <% if flash[:notice] %>
    ShopifyApp.flashNotice("<%= flash[:notice] %>");
  <% end %>

  <% if flash[:error] %>
    ShopifyApp.flashError("<%= flash[:error] %>");
  <% end %>


  });
</script>
<style>
			
		

			

			div#tabspanel {
				margin-top:20px;
				padding:10px;
				width:620px;
				background:#666;
			}
			div#tabspanel div{
				margin:0;
			
			}
			 div#tabspanel div.outer  {
				padding:10px;
				
				background:#fff;
			}
			div#tabspanel ul.tabs {
				margin:0;
				padding:10;
				
			}
			
			div#tabspanel div div.editor
			{
				padding:0;
			}
			.tabs li {
				list-style:none;
				display:inline;
			}

			.tabs a {
				padding:5px 10px;
				display:inline-block;
				background:#666;
				color:#fff;
				text-decoration:none;
			}

			.tabs a.active {
				background:#fff;
				color:#000;
				border-left:solid 1px #666;
				border-top:solid 1px #666;
				border-right:solid 1px #666;
			}
			
			

		</style>
<script type="text/javascript" src="app/assets/javascripts/tinymce/tinymce.min.js"></script>

<script type="text/javascript">
tinyMCE.init({
        theme : "modern",
        mode : "textareas",
		menu : { // this is the complete default configuration
		       // file   : {title : 'File'  , items : 'newdocument'},
		        edit   : {title : 'Edit'  , items : 'undo redo | cut copy paste pastetext | selectall'},
		        insert : {title : 'Insert', items : 'link media | template hr'},
		        view   : {title : 'View'  , items : 'visualaid'},
		        format : {title : 'Format', items : 'bold italic underline strikethrough superscript subscript | formats | removeformat'},
		        table  : {title : 'Table' , items : 'inserttable tableprops deletetable | cell row column'},
		        tools  : {title : 'Tools' , items : 'spellchecker code'}
		    },
			height : 300,
			
		plugins: [
        "advlist autolink lists link charmap preview anchor",
        "searchreplace wordcount visualblocks visualchars code fullscreen",
        "insertdatetime media nonbreaking save table contextmenu directionality",
        "template paste colorpicker textpattern"
    ],
	    toolbar1: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify ",
	       toolbar2: "bullist numlist outdent indent | link | code",
			
});
</script>


<% 
titles = Hash.new;
default_titles = Array['Summary','Details','Specs','Notes','Special']
show_value = false
contents = Hash.new;


show = 'false';

# need to reload and count metafields?
if defined? @product

@product.metafields.each do |metafield| 
 if metafield.key.include? "tab_title_" 
	 	titles[metafield.key] = metafield.value
	elsif metafield.key.include? "tab_content_" 
		contents[metafield.key] = metafield.value 
	elsif metafield.key.include? "tab_show" 	
		if metafield.value =="true"	
			show_value = true
			%>
			
<script type="text/javascript">
$(document).ready(function(){
	$('input[name="tab_show"]').prop('checked', true);
});

</script>

<% 		end
	end 
 end 

# if tab titles are blank, use defaults
for i in 1..5
	if titles[i].to_s.empty?
		titles["tab_title_" +i.to_s] = default_titles[i-1]
	end
end
 
# if any tab content equals <p>&nbsp;</p>, then make it empty string...

 
# if first tab contents are blank and description is not, or, if show tab is currently unchecked, make first tab equal the description

if contents['tab_content_1'].to_s.empty? or !show_value
	contents['tab_content_1'] = @product.body_html
end

%>

<h2>Tabbed Product Description</h2>

<p>This app allows you to create tabbed descriptions and display them instead of standard descriptions.  </p>
<ul>
	<li>If the first time to load, or if the "show tabs" box is unchecked, the first tab will show the current product description.</li>
	<li>If "show tabs" box is checked, the HTML generated by this app will overwrite the current description.</li>
</ul>

<form method="POST" action="index" data-shopify-app-submit="save-tabs-form-message">
  <input name="authenticity_token" value="<%= form_authenticity_token %>" type="hidden">
    
  <h4>Product: <%= @product.title %><!-- <%= @product.id.to_s %>--></h2>
 <input type="checkbox" name="tab_show" value="true"> Enable Tabs for this product?<br>
  
 <div id="tabspanel">
      <ul class="tabs">
		  <% counter = 1
		  begin %>
			  <li><a href="#tab<%=counter.to_s %>">Tab <%=counter%></a></li>
			  <%
			  counter = counter +1
		   end until counter > 5
		   %>
	  </ul>


		  <% counter = 1
		  begin %>
		      <div id="tab<%=counter.to_s %>" class="outer"> 
				  <label>Title <%=counter%>:</label>
				  <input type="text" name="tab_title_<%=counter.to_s %>" value="<%= titles['tab_title_'+ counter.to_s] %> "/> 
				  <div class="editor">
					  <textarea name="tab_content_<%=counter.to_s %>" rows="20" cols="80"><%= contents['tab_content_' + counter.to_s] %></textarea>
				  </div>
			  </div>
			  <%
			  counter = counter +1
		   end until counter > 5
		   %>
      
      
  </div>

<input type="hidden" name="product_id" value="<%= @product.id %>">
<input type="hidden" name="product_handle" value="<%= @product.handle %>">



</form>
<% else
	%>
	<script type="text/javascript">
	ShopifyApp.Modal.alert({
	  title: "Warning!",
	  message: "No Product currently loaded.  Please reselect a product from the admin.",
	  okButton: "I understand"
	}, function(result){
		
			ShopifyApp.redirect("/admin/products");
	
	});	
	});
	</script>
	<%
end
 %>
<h4>Notes for Beta Users</h4>
<p>Default tab names are hard coded.  Configurable defaults coming soon.</p>
<p>Documentation on CSS and JavaScript requirements coming soon.</p>
<p>If you experience any unexpected behavior or bugs, please contact <a href="mailto:john@johnakin.com">john@johnakin.com</a></p>

<p>Tabbed Product Description Shopify App - &copy; 2014 Persiliant</p>
<script type="text/javascript">

$('ul.tabs').each(function(){
  // For each set of tabs, we want to keep track of
  // which tab is active and it's associated content
  var $active, $content, $links = $(this).find('a');

  // If the location.hash matches one of the links, use that as the active tab.
  // If no match is found, use the first link as the initial active tab.
  $active = $($links.filter('[href="'+location.hash+'"]')[0] || $links[0]);
  $active.addClass('active');

  $content = $($active[0].hash);

  // Hide the remaining content
  $links.not($active).each(function () {
    $(this.hash).hide();
  });

  // Bind the click event handler
  $(this).on('click', 'a', function(e){
    // Make the old tab inactive.
    $active.removeClass('active');
    $content.hide();

    // Update the variables with the new link and content
    $active = $(this);
    $content = $(this.hash);

    // Make the tab active.
    $active.addClass('active');
    $content.show();

    // Prevent the anchor's default click action
    e.preventDefault();
  });
});
</script>
